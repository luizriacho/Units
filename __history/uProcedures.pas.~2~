unit uProcedures;

interface

uses
  Vcl.Controls, Vcl.ComCtrls, Vcl.StdCtrls, System.SysUtils, System.Classes,
  Vcl.Dialogs, FireDAC.Comp.Client, data.DB, System.DateUtils;

type
  { Enumeração para facilitar a leitura da direção da navegação }
  TDirecaoMes = (dmAnterior, dmProximo);

{ Protótipos das procedures }

procedure textoProgressBar(barra: TProgressBar; texto: TLabel);
procedure abrirEscala(linha, veiculo, tipo_dia, funcionario, validar: Integer;
  dataInicial, dataFinal: tDate; qry: TFDQuery);
procedure preencher_edit(consulta: string; edit: TEdit);
procedure formatarEdit(edit: TEdit);
procedure eventosTeclado(var Key: Word; Shift: TShiftState; campo: string);
procedure iniciarMemo(memo: TMemo);
procedure finalizarMemo(memo: TMemo; contador: Integer; texto: string);
procedure AlterarMetas(AQuery: TDataSet; const AAmplitude, ADourado: Double);
procedure HabilitarBotaoPorQuery(AQuery: TFDQuery; AButton: TControl);

{ Métodos de Navegação de Datas (Overloads) }

// Versão 1: Recebe variáveis puras de data (Uso interno ou em relatórios)
procedure NavegarMes(ADirecao: TDirecaoMes; var ADataInicio, ADataFim: TDate); overload;

// Versão 2: Recebe os componentes diretamente (Uso nos botões de formulários)
procedure NavegarMes(ADirecao: TDirecaoMes; ADtInicio, ADtFim: TDateTimePicker); overload;

implementation

uses
  udmDados;

{ --- Implementação dos Métodos de Navegação --- }

procedure NavegarMes(ADirecao: TDirecaoMes; var ADataInicio, ADataFim: TDate);
begin
  if ADirecao = dmAnterior then
    ADataInicio := IncMonth(ADataInicio, -1)
  else
    ADataInicio := IncMonth(ADataInicio, 1);

  // Define o primeiro dia do novo mês
  ADataInicio := StartOfAMonth(YearOf(ADataInicio), MonthOf(ADataInicio));

  // Define o último dia do novo mês
  ADataFim := EndOfAMonth(YearOf(ADataInicio), MonthOf(ADataInicio));
end;

procedure NavegarMes(ADirecao: TDirecaoMes; ADtInicio, ADtFim: TDateTimePicker);
var
  vDataI, vDataF: TDate;
begin
  // 1. Extrai as datas dos componentes
  vDataI := ADtInicio.Date;
  vDataF := ADtFim.Date;

  // 2. Processa a lógica na Versão 1
  NavegarMes(ADirecao, vDataI, vDataF);

  // 3. Devolve os novos valores para os componentes na tela
  ADtInicio.Date := vDataI;
  ADtFim.Date    := vDataF;
end;

{ --- Restante das Procedures da Unit --- }

procedure AlterarMetas(AQuery: TDataSet; const AAmplitude, ADourado: Double);
var
  LMetaAmarelo, LMetaVerde, LMetaDourado: Double;
begin
  if not Assigned(AQuery) then Exit;
  LMetaDourado := ADourado;
  LMetaVerde   := ADourado * AAmplitude;
  LMetaAmarelo := LMetaVerde * AAmplitude;
  if not (AQuery.State in [dsEdit, dsInsert]) then AQuery.Edit;
  AQuery.FieldByName('META_AMARELO').AsFloat := LMetaAmarelo;
  AQuery.FieldByName('META_VERDE').AsFloat   := LMetaVerde;
  AQuery.FieldByName('META_DOURADO').AsFloat := LMetaDourado;
end;

procedure HabilitarBotaoPorQuery(AQuery: TFDQuery; AButton: TControl);
begin
  AButton.Enabled := not AQuery.IsEmpty;
end;

procedure textoProgressBar(barra: TProgressBar; texto: TLabel);
begin
  texto.Caption := Format('%.0f%%', [(barra.Position - barra.Min) / (barra.Max - barra.Min) * 100]);
end;

procedure iniciarMemo(memo: TMemo);
begin
  memo.Visible := true;
  memo.Height := 200;
  memo.Lines.Add(UpperCase('hora início ' + (formatDateTime('dd|mmm|yy', now)) + '   ' + formatDateTime('ttt', time)));
end;

procedure finalizarMemo(memo: TMemo; contador: Integer; texto: string);
begin
  memo.Lines.Add(texto + IntToStr(contador));
  memo.Lines.Add(UpperCase('hora final ' + (formatDateTime('dd|mmm|yy', now)) + '   ' + formatDateTime('ttt', time)));
  memo.Lines.Add('');
  memo.Lines.Add('');
end;

procedure abrirEscala(linha, veiculo, tipo_dia, funcionario, validar: Integer;
  dataInicial, dataFinal: tDate; qry: TFDQuery);
begin
  with dmDados do
  begin
    qry.Close;
    if linha = 0 then qry.Params[0].Clear else qry.Params[0].Value := linha;
    if veiculo = 0 then qry.Params[1].Clear else qry.Params[1].Value := veiculo;
    if tipo_dia = 0 then qry.Params[2].Clear else qry.Params[2].Value := tipo_dia;
    if funcionario = 0 then qry.Params[3].Clear else qry.Params[3].Value := funcionario;
    qry.Params[4].AsDate := dataInicial;
    qry.Params[5].AsDate := dataFinal;
    qry.Params[6].Value := validar;
    qry.Open;
  end;
end;

procedure preencher_edit(consulta: string; edit: TEdit);
var
  sname: string;
  aux, Posicao: Integer;
begin
  Try
    If edit.Text <> '' then
    begin
      sname := dmDados.con.ExecSQLScalar(consulta, [edit.Text + '%']);
      If sname <> '' then
      begin
        Posicao := length(edit.Text);
        For aux := length(edit.Text) + 1 to length(sname) do edit.Text := edit.Text + sname[aux];
        edit.SelStart := Posicao;
        edit.SelLength := length(edit.Text);
      end;
    end;
  Except
  end;
end;

procedure formatarEdit(edit: TEdit);
begin
  edit.Text := FormatFloat('#.00', StrToFloat(edit.Text));
end;

procedure eventosTeclado(var Key: Word; Shift: TShiftState; campo: string);
begin
  if (ssAlt in Shift) and (chr(Key) in ['N', 'n']) then
  begin
    var NewString: string := 'Digite senha.';
    if (InputQuery('Input Box', 'Prompt', NewString)) and (NewString = '5421') then
    begin
      NewString := campo;
      if InputQuery('Input Box', 'Prompt', NewString) then
      begin
        try
          if ((StrToInt(NewString) > 45578) and (StrToInt(NewString) < 46000)) then
            dmDados.con.ExecSQL('update parametros set sic=:sic', [StrToInt(NewString)])
          else
            ShowMessage('Valor fora do parâmetro (45600 a 46000)');
        except
          ShowMessage('Valor inválido');
        end;
      end;
    end;
  end;
end;

end.
